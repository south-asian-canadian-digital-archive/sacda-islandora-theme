<?php

declare(strict_types=1);

/**
 * @file
 * Functions to support theming in the sacda theme.
 */

use Drupal\Core\Form\FormStateInterface;

require_once __DIR__ . '/includes/colors.inc';
require_once __DIR__ . '/includes/footer.inc';
require_once __DIR__ . '/includes/carousel.inc';
require_once __DIR__ . '/includes/theme_settings.inc';
require_once __DIR__ . '/includes/theme_settings_callbacks.inc';
require_once __DIR__ . '/includes/suggestions.inc';

/**
 * Implements hook_form_system_theme_settings_alter().
 */
function sacda_form_system_theme_settings_alter(array &$form, FormStateInterface $form_state): void {
  _sacda_build_theme_settings_form($form, $form_state);
}

/**
 * Implements hook_preprocess_HOOK() for html.html.twig.
 */
function sacda_preprocess_html(array &$variables): void {
  $is_dev = getenv('DRUPAL_ENV') === 'development' ||
            file_exists(DRUPAL_ROOT . '/sites/development.services.yml');

  if ($is_dev) {
    // $variables['page']['#attached']['html_head'][] = [
    //   [
    //     '#type' => 'html_tag',
    //     '#tag' => 'script',
    //     '#attributes' => ['src' => 'http://localhost:35729/livereload.js'],
    //   ],
    //   'livereload',
    // ];
  }

  $variables['page']['#attached']['html_head'][] = [
    [
      '#type' => 'html_tag',
      '#tag' => 'meta',
      '#attributes' => [
        'name' => 'viewport',
        'content' => 'width=device-width, initial-scale=1.0',
      ],
    ],
    'viewport',
  ];
}

/**
 * Implements hook_preprocess_HOOK() for page.html.twig.
 */
function sacda_preprocess_page(array &$variables): void {
  $theme_path = '/' . \Drupal::theme()->getActiveTheme()->getPath();

  $variables['site_name'] = \Drupal::config('system.site')->get('name');
  $variables['current_year'] = date('Y');
  $variables['theme_path'] = $theme_path;
  $variables['logo'] = $theme_path . '/logo.svg';
  $variables['is_front'] = \Drupal::service('path.matcher')->isFrontPage();




  _sacda_preprocess_footer_partners($variables, $theme_path);
  _sacda_preprocess_footer_social($variables);
  _sacda_add_color_variables($variables);
  _sacda_preprocess_carousel($variables, $theme_path);
}

/**
 * Implements hook_preprocess_HOOK() for node.html.twig.
 */
/**
 * Implements hook_preprocess_HOOK() for node.html.twig.
 */
function sacda_preprocess_node(array &$variables): void {
  /** @var \Drupal\node\NodeInterface $node */
  $node = $variables['node'];
  $type = $node->getType();

  // Helper to extract File URL from Media Entity Reference
  $get_media_url = function ($field_name) use ($node) {
    if ($node->hasField($field_name) && !$node->get($field_name)->isEmpty()) {
      $entity = $node->get($field_name)->entity;
      if ($entity && $entity->getEntityTypeId() === 'media') {
        // Assuming 'field_media_image' is the image field on the Media entity
        if ($entity->hasField('field_media_image') && !$entity->get('field_media_image')->isEmpty()) {
          $file = $entity->get('field_media_image')->entity;
            if ($file) {
              return \Drupal::service('file_url_generator')->generateAbsoluteString($file->getFileUri());
            }
        }
      }
      // Handle case where field might be direct file ref (though unlikely for defined Media type)
      elseif ($entity && $entity->getEntityTypeId() === 'file') {
         return \Drupal::service('file_url_generator')->generateAbsoluteString($entity->getFileUri());
      }
    }
    return NULL;
  };

  // 1. Collection Preprocess
  if ($type === 'collection') {
    // Image logic removed - handled in page preprocess

    $variables['collection'] = [
      'title' => $node->getTitle(),
      'full_title' => $node->hasField('field_full_title') ? $node->get('field_full_title')->value : '',
      'description' => $node->hasField('field_description') ? $node->get('field_description')->value : '',
      'cover_image_url' => $get_media_url('field_cover_image'),
      // Add member_of title if needed
    ];
  }

  // 2. Collection File Preprocess
  if ($type === 'collection_file') {
     $variables['collection_file'] = [
      'date' => $node->hasField('field_date') ? $node->get('field_date')->value : '',
      'description' => $node->hasField('field_description') ? $node->get('field_description')->value : '',
      'full_title' => $node->hasField('field_full_title') ? $node->get('field_full_title')->value : '',
     ];
  }

  // 3. Repository Item Preprocess
  if ($type === 'repository_item') {
    // Extract commonly used fields for easier template access
    $variables['repository_item'] = [
      'abstract' => $node->hasField('field_abstract') ? $node->get('field_abstract')->value : null,
      'alt_title' => $node->hasField('field_alt_title') ? $node->get('field_alt_title')->value : null,
      'copyright_date' => $node->hasField('field_copyright_date') ? $node->get('field_copyright_date')->value : null,
      'date_created' => $node->hasField('field_edtf_date_created') ? $node->get('field_edtf_date_created')->value : null,
      'date_issued' => $node->hasField('field_edtf_date_issued') ? $node->get('field_edtf_date_issued')->value : null,
      'description' => $node->hasField('field_description') ? $node->get('field_description')->value : null,
      'extent' => $node->hasField('field_extent') ? $node->get('field_extent')->value : null,
      'identifier' => $node->hasField('field_identifier') ? $node->get('field_identifier')->value : null,
      'publisher' => $node->hasField('field_publisher') ? $node->get('field_publisher')->value : null,
      'representative_image_url' => $get_media_url('field_representative_image'),
    ];
  }
}

/**
 * Implements hook_preprocess_HOOK() for block templates.
 */
function sacda_preprocess_block(array &$variables): void {
  _sacda_add_color_variables($variables);

  if (isset($variables['elements']['#id'])) {
    $variables['attributes']['data-block-id'] = $variables['elements']['#id'];
  }
}

/**
 * Implements hook_preprocess_HOOK() for menu templates.
 */
function sacda_preprocess_menu(array &$variables): void {
  _sacda_add_color_variables($variables);
}

/**
 * Implements hook_preprocess_HOOK() for views_view_fields templates.
 *
 * Adds a default placeholder image for collections without cover images.
 */
function sacda_preprocess_views_view_fields(array &$variables): void {
  $view = $variables['view'];
  $view_id = $view->id();
  $theme_path = '/' . \Drupal::theme()->getActiveTheme()->getPath();

  // List of views that need image handling
  $image_views = ['top_level_collections', 'solr_search_content'];

  if (in_array($view_id, $image_views)) {
    $variables['default_collection_image'] = $theme_path . '/static/collections/default.jpg';

    // Check multiple possible image field names
    $image_field_names = ['did_image', 'field_image', 'thumbnail', 'field_thumbnail', 'field_representative_image'];
    $variables['has_image'] = FALSE;
    $variables['image_field_name'] = NULL;

    foreach ($image_field_names as $field_name) {
      if (isset($variables['fields'][$field_name])) {
        $image_content = trim(strip_tags((string) $variables['fields'][$field_name]->content));
        if (!empty($image_content)) {
          $variables['has_image'] = TRUE;
          $variables['image_field_name'] = $field_name;
          break;
        }
      }
    }
  }
}


